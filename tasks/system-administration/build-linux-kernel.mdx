---
title: 'Build Linux Kernel'
description: 'Build Linux kernel from source with custom modifications and run in QEMU environment'
---

<CardGroup>
  <Card title="Difficulty" icon="alert-circle">
    <Badge variant="secondary">Medium</Badge>
  </Card>
  <Card title="Category" icon="server">
    System Administration
  </Card>
  <Card title="Estimated Time" icon="clock">
    45-60 minutes
  </Card>
</CardGroup>

## Task Description

Build Linux kernel version 6.9 from source with custom modifications. The task involves:

1. Downloading and configuring the Linux kernel source
2. Adding a custom print statement to the kernel
3. Building the kernel with proper configuration
4. Creating an initramfs
5. Running the kernel in QEMU

## Prerequisites

- Linux environment with build tools
- QEMU installed
- Sufficient disk space (at least 2GB)
- Internet connection for downloading source

## Instructions

### Step 1: Download Kernel Source

```bash
# Download Linux kernel 6.9
wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.9.tar.xz
tar -xf linux-6.9.tar.xz
cd linux-6.9
```

### Step 2: Add Custom Modification

Add the following line to the `start_kernel` function in `init/main.c`:

```c
printk(KERN_INFO "Hello, this is a custom kernel");
```

The modification should be placed early in the `start_kernel` function, after the initial setup but before major subsystems are initialized.

### Step 3: Configure Kernel

```bash
# Use default configuration for x86_64
make x86_64_defconfig

# Optional: Enable additional features
make menuconfig
```

### Step 4: Build Kernel

```bash
# Build the kernel (adjust -j parameter based on CPU cores)
make -j$(nproc)

# Verify the kernel image was created
ls -la arch/x86/boot/bzImage
```

### Step 5: Create Initramfs

```bash
# Create ramfs directory structure
mkdir -p ramfs/{bin,sbin,etc,proc,sys,dev}
cd ramfs

# Create a simple init script
cat > init << 'EOF'
#!/bin/sh
echo "Custom kernel booted successfully!"
echo "Hello from the custom kernel!"
exec /bin/sh
EOF

chmod +x init

# Generate initramfs
find . | cpio -o -H newc | gzip > ../initramfs.cpio.gz
cd ..
```

### Step 6: Run in QEMU

```bash
qemu-system-x86_64 \
  -kernel arch/x86/boot/bzImage \
  -initrd initramfs.cpio.gz \
  -append "console=ttyS0" \
  -nographic
```

## Expected Output

When the kernel boots successfully, you should see:

1. Kernel boot messages including your custom print statement
2. The message "Custom kernel booted successfully!"
3. A working shell prompt

## Success Criteria

- [ ] Kernel builds without errors
- [ ] Custom print statement appears in boot messages
- [ ] Kernel boots successfully in QEMU
- [ ] Initramfs loads and executes
- [ ] Shell prompt is accessible

## Troubleshooting

<AccordionGroup>
  <Accordion title="Build Errors">
    - Ensure all build dependencies are installed
    - Check available disk space
    - Verify kernel source integrity
  </Accordion>
  <Accordion title="QEMU Issues">
    - Install QEMU: `sudo apt-get install qemu-system-x86`
    - Check virtualization support in BIOS
    - Try different QEMU parameters
  </Accordion>
  <Accordion title="Initramfs Problems">
    - Verify init script permissions
    - Check initramfs generation process
    - Ensure proper directory structure
  </Accordion>
</AccordionGroup>

## Evaluation

This task evaluates:

- **System Administration Skills**: Kernel compilation, system configuration
- **Build Process Understanding**: Makefiles, compilation flags, dependencies
- **Virtualization Knowledge**: QEMU usage, kernel parameters
- **Problem Solving**: Debugging build and runtime issues

<Info>
  **Created by**: Nicholas Carlini  
  **Last Updated**: December 2024  
  **Tags**: `system`, `kernel`, `build`, `qemu`
</Info>
